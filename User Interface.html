
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
</head>
<body>
<h1 id = "allChallenges"></h1>
<p id = "score"></p>
<p id = "quessionNum"></p>
<p id = correctScore></p>
<ul id = "challenges">
</ul>
<label id = "getName">

</label>

<p id = "guestion"></p>
<p id = "error"></p>
<p id = "location"></p>
<input type = "hidden" onclick="question()" id = "cookie">
<input type = "hidden" onclick="deleteCookie()" id = "deleteCookie">
<input type = "hidden" onclick="skip()" id = skip>
<input type = "hidden" onclick="answer(true)" id = true>
<input type = "hidden" onclick="answer(false)" id = false>
<input type="hidden" placeholder="Type something..." id="myInput">
<input type="hidden" onclick="getInputValue();" id ="submit" >
<input type="hidden" onclick="answer('A')" id="mcq">
<input type="hidden" onclick="answer('B')" id ="mcq1" >
<input type="hidden" onclick="answer('C')" id="mcq2">
<input type="hidden" onclick="answer('D')" id ="mcq3">


<script>
    var Latitude;
    var Longitude;
    var idVar;
    let sessionID;
    var validName;
    let uuid;
    let getName;
    let list;
    let challenges;
    let players;

    function setCookie(cname,cvalue,exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*10*60*1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function checkCookie() {
        var user = getCookie("username");
        if (user != "") {
            let cookie = document.getElementById("cookie");
            let deleteCookie = document.getElementById("deleteCookie");
            cookie.value = "Continue";
            cookie.type = "button";
            deleteCookie.type = "button";
            deleteCookie.value = "New Game";
            sessionID = user;
        } else{
            getname();
        }

    }
    function deleteCookie() {
        document.cookie = "username=;  path=/;";

        getname();
    }
    checkCookie();



    function getname() {
        fetch("https://codecyprus.org/th/api/list?include-active")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.
                challenges = document.getElementById("allChallenges").innerHTML = "All Challenges";
                let cookie = document.getElementById("cookie").type = "hidden";
                let deleteCookie = document.getElementById("deleteCookie").type = "hidden";
                list = document.getElementById("challenges");
                let array = jsonObject.treasureHunts;
                for(let i =0; i <array.length; i++) {
                    let listItem = document.createElement("button");
                    listItem.value = array[i].uuid;
                    listItem.innerHTML = array[i].name;
                    list.appendChild(listItem);
                    getName = document.getElementById("getName");
                    let text = document.createElement("p");
                    let name = document.createElement("input");
                    let submit = document.createElement("input");


                    listItem.onclick = function () {
                        uuid = listItem.value;
                        list.remove();
                        text.innerText = "Enter name name/nickname";
                        submit.type = "submit";
                        submit.value = "Start";
                        getName.appendChild(text);
                        getName.appendChild(name);
                        getName.appendChild(submit);

                        submit.onclick = function () {
                            validName = name.value;
                            start();
                        }
                    };
                }
            });
    }
    function start() {
        fetch("https://codecyprus.org/th/api/start?player=" + validName + "&app=Sample-treasure-hunt&treasure-hunt-id=" + uuid + "")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                if (myObj.status === "ERROR") {
                    document.getElementById("error").innerHTML = myObj.errorMessages;
                } else {
                    getName.remove();
                    challenges = document.getElementById("allChallenges").innerHTML = "";
                    document.getElementById("error").innerHTML = "";
                    sessionID = myObj.session;
                    setCookie("username", sessionID, 1);

                    question()
                }
            });
    }

    function question() {
        fetch("https://codecyprus.org/th/api/question?session=" + sessionID + "")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                if (myObj.status === "ERROR") {
                    document.getElementById("error").innerHTML = myObj.errorMessages;
                }
                else {
                    document.getElementById("guestion").innerHTML = myObj.questionText;
                }
                if(myObj.completed == false) {
                    let currentQuestionIndex = myObj.currentQuestionIndex + 1;
                    document.getElementById("quessionNum").innerHTML = "QUESTIONS: "+ currentQuestionIndex + "/" + myObj.numOfQuestions;
                    document.getElementById("correctScore").innerHTML = "Correct Score: " + myObj.correctScore + " Wrong Score" + myObj.wrongScore;
                    score();
                    document.getElementById("location").innerHTML = "";
                    document.getElementById("error").innerHTML = "";

                    if (myObj.canBeSkipped == true) {
                        var skip = document.getElementById("skip");
                        skip.type = "button";
                        skip.value = "SKIP "+ myObj.skipScore;
                    } else {
                        var skip = document.getElementById("skip");
                        skip.type = "hidden";

                    }
                    if (myObj.requiresLocation == true) {
                        myLocation();
                        loopLocation();

                    }
                    else {
                        clearInterval(idVar);
                    }

                    if (myObj.questionType == "BOOLEAN") {
                        var True = document.getElementById("true");
                        var False = document.getElementById("false");
                        True.type = "button";
                        True.value = "TRUE";
                        False.type = "button";
                        False.value = "FALSE";
                    } else {
                        var True = document.getElementById("true");
                        var False = document.getElementById("false");
                        True.type = "hidden";
                        False.type = "hidden";
                    }
                    if (myObj.questionType == "INTEGER" || myObj.questionType == "NUMERIC" || myObj.questionType == "TEXT") {
                        var myInput = document.getElementById("myInput");
                        var submit = document.getElementById("submit");
                        myInput.type = "text";
                        myInput.value = "";
                        submit.type = "button";
                        submit.value = "SUBMIT";
                    } else {
                        var myInput = document.getElementById("myInput");
                        var submit = document.getElementById("submit");
                        myInput.type = "hidden";
                        submit.type = "hidden";
                    }
                    if(myObj.questionType == "MCQ"){
                        var mcq1 = document.getElementById("mcq");
                        var mcq2 = document.getElementById("mcq1");
                        var mcq3 = document.getElementById("mcq2");
                        var mcq4 = document.getElementById("mcq3");
                        mcq1.type = "button";
                        mcq1.value = "A";
                        mcq2.type = "button";
                        mcq2.value = "B";
                        mcq3.type = "button";
                        mcq3.value = "C";
                        mcq4.type = "button";
                        mcq4.value = "D";
                    }
                    else{
                        var mcq1 = document.getElementById("mcq");
                        var mcq2 = document.getElementById("mcq1");
                        var mcq3 = document.getElementById("mcq2");
                        var mcq4 = document.getElementById("mcq3");
                        mcq1.type = "hidden";
                        mcq2.type = "hidden";
                        mcq3.type = "hidden";
                        mcq4.type = "hidden";
                    }
                }
                else if(myObj.completed == true){
                    score();
                    leaderboard();
                    clearInterval(idVar);
                    document.getElementById("location").innerHTML = "";
                    document.getElementById("error").innerHTML = "";
                    document.getElementById("quessionNum").innerHTML = "";
                    document.getElementById("correctScore").innerHTML ="";
                    var True = document.getElementById("true");
                    var False = document.getElementById("false");
                    True.type = "hidden";
                    False.type = "hidden";
                    var myInput = document.getElementById("myInput");
                    var submit = document.getElementById("submit");
                    myInput.type = "hidden";
                    submit.type = "hidden";
                    var skip = document.getElementById("skip");
                    skip.type = "hidden";
                    var mcq1 = document.getElementById("mcq");
                    var mcq2 = document.getElementById("mcq1");
                    var mcq3 = document.getElementById("mcq2");
                    var mcq4 = document.getElementById("mcq3");
                    mcq1.type = "hidden";
                    mcq2.type = "hidden";
                    mcq3.type = "hidden";
                    mcq4.type = "hidden";
                    deleteCookie()



                }

            });
    }
    function score() {
        fetch("https://codecyprus.org/th/api/score?session=" + sessionID + "")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                if (myObj.status === "ERROR") {
                    document.getElementById("error").innerHTML = myObj.errorMessages;
                }
                else {
                    document.getElementById("score").innerHTML = "Username: " + myObj.player + "<br>Score: " + myObj.score;

                }
            });
    }
    function loopLocation() {
        idVar = setInterval (()  => {
            myLocation();
        }, 35000)
    }
    function myLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);


        }
        else {
            alert("Geolocation is not supported by your browser."); //TODO - Geolocation is NOT supported by browser.
        }

    }
    function showPosition(position) {
        Latitude = position.coords.latitude;
        Longitude = position.coords.longitude;
        console.log(Latitude, Longitude);
        getlocation()


    }
    function getlocation( ){
        fetch("https://codecyprus.org/th/api/location?session="+sessionID+ "&latitude="+Latitude+"&longitude="+Longitude+"")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                if (myObj.status === "ERROR") {
                    document.getElementById("error").innerHTML = myObj.errorMessages;
                }
                else {
                    document.getElementById("location").innerHTML = myObj.message;
                }
            });

    }
    function skip() {
        fetch("https://codecyprus.org/th/api/skip?session="+ sessionID + "")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                question();
            });
    }
    function getInputValue(){
        var inputVal = document.getElementById("myInput").value;
        answer(inputVal);
    }
    function answer(answer) {
        fetch("https://codecyprus.org/th/api/answer?session="+ sessionID + "&answer="+answer+"")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                if(myObj.correct == false){
                    document.getElementById("error").innerHTML = myObj.message;
                }else {
                    question();
                    clearInterval(idVar);
                }

            });
    }
    function leaderboard() {
        fetch("https://codecyprus.org/th/api/leaderboard?session="+ sessionID + "&sorted&limit=10")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;
                players = myObj.numOfPlayers;
                myPositionLeaderboard();

            });
    }
    function myPositionLeaderboard() {
        fetch("https://codecyprus.org/th/api/leaderboard?session="+ sessionID + "&sorted&limit="+players+"")
            .then(response => response.json()) //Parse JSON text to JavaScript object
            .then(jsonObject => {
                console.log(jsonObject); //TODO - Success, do something with the data.//
                var myObj = jsonObject;

                let array = myObj.leaderboard;
                for(let i = 0; i < array.length; i++){
                    let players =  array[i].player;
                    if(array[i].player == validName){
                        alert("found: " + i);
                    }
                }
            });
    }

</script>
</body>
</html>